- name: Create project group
  group:
    name: "{{ project_group }}"
    state: present

- name: Check if project user exists
  getent:
    database: passwd
    key: "{{ project_user }}"
  register: project_user_info
  ignore_errors: yes

- name: Create project user
  user:
    name: "{{ project_user }}"
    group: "{{ project_group }}"
    home: "{{ project_home }}"
    shell: /bin/bash
    create_home: yes
    system: no
  when: project_user_info.failed

- name: Check if deploy user exists
  getent:
    database: passwd
    key: "{{ deploy_user }}"
  register: deploy_user_info
  ignore_errors: yes

- name: Create deploy user
  user:
    name: "{{ deploy_user }}"
    groups:
      - "{{ project_group }}"
      - docker
    home: "/home/{{ deploy_user }}"
    shell: /bin/bash"
    create_home: yes
    system: no
  when: deploy_user_info.failed

- name: Add GitHub Actions SSH key for deploy user
  authorized_key:
    user: "{{ deploy_user }}"
    key: "{{ github_actions_ssh_key }}"
    state: present

- name: Check existing developer accounts
  getent:
    database: passwd
  register: passwd_db

- name: Create developer users
  user:
    name: "{{ item.name }}"
    groups: "{{ project_group }}"
    shell: /bin/bash
    create_home: yes
  loop: "{{ developers }}"
  when: item.name not in getent_passwd.keys()

- name: Unlock account with empty password
  command: "passwd -d {{ item.name }}"
  loop: "{{ developers }}"
  when: item.name not in getent_passwd.keys()

- name: Force password change on first login
  command: "chage -d 0 {{ item.name }}"
  loop: "{{ developers }}"
  when: item.name not in getent_passwd.keys()

- name: Add SSH keys for developers
  authorized_key:
    user: "{{ item.name }}"
    key: "{{ item.ssh_key }}"
    state: present
  loop: "{{ developers }}"

- name: Grant sudo access to developers with root access
  user:
    name: "{{ item.name }}"
    groups: sudo
    append: yes
  loop: "{{ developers }}"
  when: item.root_access | default(false)